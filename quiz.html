<!doctype html>
<html lang="it">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Arte Trainer â€“ Quiz</title>
    
    <link rel="stylesheet" href="styles.css">
    

</head>

<body data-page="quiz">
    <header class="site-header">
        <h1>Quiz di riconoscimento</h1>
        <p class="subtitle" id="quiz-subtitle"></p>
    </header>

    <main class="container">
        <div class="toolbar">
            <a class="btn" href="index.html">Home</a>
            <a class="btn" href="gallery.html">Raccolta</a>
            <button class="btn" id="btn-restart">Ricrea quiz</button>
        </div>

        <section id="stage" class="quiz-stage panel">
            <div class="progress"><span id="quiz-idx">0</span> / <span id="quiz-tot">0</span></div>

            <article class="card quiz">
                <!-- Riquadro a dimensione fissa (imposta in styles.css con --quiz-w / --quiz-h) -->
                <div class="quiz-frame">
                    <img id="q-img" class="quiz-img" alt="">
                </div>

                <div class="info">
                    <button id="btn-show" class="btn primary">Mostra soluzione</button>

                    <div id="solution" class="solution hidden">
                        <h3 id="q-title" class="title"></h3>
                        <p><strong>Artista:</strong> <span id="q-artist"></span></p>
                        <p><strong>Anno:</strong> <span id="q-year"></span></p>
                        <p><strong>Tecnica:</strong> <span id="q-tech"></span></p>
                    </div>

                    <div id="esito" class="esito hidden">
                        <button id="btn-correct" class="btn success">Ho indovinato</button>
                        <button id="btn-wrong" class="btn danger">Ho sbagliato</button>
                        <button id="btn-skip" class="btn">Salta</button>
                    </div>
                </div>
            </article>
        </section>
    </main>

    <!-- Full-screen viewer -->
    <div id="viewer" class="viewer" aria-hidden="true">
        <img id="viewer-img" alt="">
        <div class="hint">clic per chiudere Â· ESC per uscire</div>
    </div>

    <script src="app.js"></script>
    <script>
        (async function () {
            const A = window.ArteTrainer;

            // Parametri quiz da URL
            const params = new URLSearchParams(location.search);
            const mode = params.get('mode') || 'all';
            const threshold = +(params.get('threshold') || 50);
            const limit = +(params.get('limit') || 9999);
            const unseen = params.get('unseen') === '1';
            const q = (params.get('q') || '').trim().toLowerCase();

            // Sottotitolo
            const subtitle = document.getElementById('quiz-subtitle');
            subtitle.textContent = mode === 'advanced'
                ? `Avanzato: sotto ${threshold}%${unseen ? ' + mai allenate' : ''}${q ? ` â€¢ filtro: "${q}"` : ''}`
                : 'Tutte le opere (ordine casuale)';

            // Carica e filtra opere
            let opere = await A.caricaOpere();
            if (q) {
                opere = opere.filter(o => (o.titolo + ' ' + o.artista + ' ' + o.tecnica + ' ' + o.anno)
                    .toLowerCase().includes(q));
            }
            if (mode === 'advanced') {
                opere = opere.filter(o => {
                    const { pct } = A.getPerf(o.id);
                    return pct === null ? unseen : (pct < threshold);
                });
            }
            opere = A.shuffle(opere);
            if (opere.length === 0) {
                alert('Nessuna opera corrisponde ai criteri del quiz.');
                location.href = 'advanced.html';
                return;
            }
            if (isFinite(limit)) opere = opere.slice(0, limit);

            // Riferimenti DOM
            const stage = document.getElementById('stage');
            const img = document.getElementById('q-img');
            const title = document.getElementById('q-title');
            const artist = document.getElementById('q-artist');
            const year = document.getElementById('q-year');
            const tech = document.getElementById('q-tech');
            const btnShow = document.getElementById('btn-show');
            const solution = document.getElementById('solution');
            const esito = document.getElementById('esito');
            const idxEl = document.getElementById('quiz-idx');
            const totEl = document.getElementById('quiz-tot');
            const btnCorrect = document.getElementById('btn-correct');
            const btnWrong = document.getElementById('btn-wrong');
            const btnSkip = document.getElementById('btn-skip');
            const btnRestart = document.getElementById('btn-restart');

            // Stato quiz
            let idx = 0;
            totEl.textContent = String(opere.length);

            function renderCurrent() {
                const o = opere[idx];
                idxEl.textContent = String(idx + 1);
                img.src = o.immagine;
                img.alt = `${o.titolo} â€“ ${o.artista}`;
                title.textContent = o.titolo || 'Senza titolo';
                artist.textContent = o.artista || 'Sconosciuto';
                year.textContent = o.anno || 'â€”';
                tech.textContent = o.tecnica || 'â€”';

                // reset UI
                btnShow.classList.remove('hidden');
                solution.classList.add('hidden');
                esito.classList.add('hidden');
                stage.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }

            function next() {
                idx++;
                if (idx >= opere.length) {
                    alert('Quiz concluso! ðŸŽ‰');
                    location.href = 'index.html';
                    return;
                }
                renderCurrent();
            }

            btnShow.addEventListener('click', () => {
                btnShow.classList.add('hidden');
                solution.classList.remove('hidden');
                esito.classList.remove('hidden');
            });
            btnCorrect.addEventListener('click', () => { A.registraEsito(opere[idx].id, true); next(); });
            btnWrong.addEventListener('click', () => { A.registraEsito(opere[idx].id, false); next(); });
            btnSkip.addEventListener('click', () => { next(); });
            btnRestart.addEventListener('click', () => location.reload());

            // Viewer full-screen
            (function () {
                const viewer = document.getElementById('viewer');
                const vimg = document.getElementById('viewer-img');
                img.style.cursor = 'zoom-in';
                img.addEventListener('click', () => { vimg.src = img.src; vimg.alt = img.alt || ''; viewer.classList.add('open'); });
                viewer.addEventListener('click', () => viewer.classList.remove('open'));
                document.addEventListener('keydown', (e) => { if (e.key === 'Escape') viewer.classList.remove('open'); });
            })();

            renderCurrent();
        })();
    </script>
</body>

</html>