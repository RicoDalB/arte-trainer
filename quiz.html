<!doctype html>
<html lang="it">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Arte Trainer â€“ Quiz</title>

    <link rel="stylesheet" href="styles.css">
</head>

<body data-page="quiz">
    <header class="site-header">
        <h1>Quiz di riconoscimento</h1>
        <p class="subtitle" id="quiz-subtitle"></p>
    </header>

    <main class="container">
        <div class="toolbar">
            <a class="btn" href="index.html">Home</a>
            <a class="btn" href="gallery.html">Raccolta</a>
            <button class="btn" id="btn-restart" type="button">Ricrea quiz</button>
            <button class="btn danger" id="btn-exit" type="button">Esci</button>
        </div>

        <section id="stage" class="quiz-stage panel">
            <div class="progress"><span id="quiz-idx">0</span> / <span id="quiz-tot">0</span></div>

            <article class="card quiz">
                <div class="quiz-image">
                    <img id="q-img" alt="">
                </div>
                <div class="quiz-info">
                    <button id="btn-show" class="btn primary">Mostra soluzione</button>

                    <!-- QUI Ã¨ cambiato: soluzione in verticale -->
                    <div id="solution" class="solution hidden">
                        <ul class="solution-list">
                            <li><span id="q-title"></span></li>
                            <li><span id="q-artist"></span></li>
                            <li><span id="q-year"></span></li>
                            <li><span id="q-tech"></span></li>
                        </ul>
                    </div>


                    <div id="esito" class="esito hidden">
                        <button id="btn-correct" class="btn success">Ho indovinato</button>
                        <button id="btn-wrong" class="btn danger">Ho sbagliato</button>
                        <button id="btn-skip" class="btn">Salta</button>
                    </div>
                </div>
            </article>
        </section>
    </main>

    <!-- Full-screen viewer -->
    <div id="viewer" class="viewer" aria-hidden="true">
        <img id="viewer-img" alt="">
        <div class="hint">clic per chiudere Â· ESC per uscire</div>
    </div>

    <script src="app.js"></script>
    <script>
        (async function () {
            const A = window.ArteTrainer;
            const QUIZ_STATE_KEY = 'arteTrainerQuizState.v1';

            function loadQuizState() {
                try {
                    return JSON.parse(localStorage.getItem(QUIZ_STATE_KEY) || 'null');
                } catch (e) {
                    return null;
                }
            }

            function saveQuizState(state) {
                try {
                    localStorage.setItem(QUIZ_STATE_KEY, JSON.stringify(state));
                } catch (e) {
                    // ignore
                }
            }

            function clearQuizState() {
                localStorage.removeItem(QUIZ_STATE_KEY);
            }

            // Parametri quiz da URL
            const params = new URLSearchParams(location.search);
            const mode = params.get('mode') || 'all';
            const threshold = +(params.get('threshold') || 50);
            const limit = +(params.get('limit') || 9999);
            const unseen = params.get('unseen') === '1';
            const q = (params.get('q') || '').trim().toLowerCase();
            const resume = params.get('resume') === '1';

            // Riferimenti DOM
            const subtitle = document.getElementById('quiz-subtitle');
            const stage = document.getElementById('stage');
            const img = document.getElementById('q-img');
            const title = document.getElementById('q-title');
            const artist = document.getElementById('q-artist');
            const year = document.getElementById('q-year');
            const tech = document.getElementById('q-tech');
            const btnShow = document.getElementById('btn-show');
            const solution = document.getElementById('solution');
            const esito = document.getElementById('esito');
            const idxEl = document.getElementById('quiz-idx');
            const totEl = document.getElementById('quiz-tot');
            const btnCorrect = document.getElementById('btn-correct');
            const btnWrong = document.getElementById('btn-wrong');
            const btnSkip = document.getElementById('btn-skip');
            const btnRestart = document.getElementById('btn-restart');
            const btnExit = document.getElementById('btn-exit');

            let opere;
            let idx = 0;

            if (resume) {
                // Riprendi da stato salvato
                const saved = loadQuizState();
                if (!saved || !Array.isArray(saved.opere) || !saved.opere.length) {
                    alert('Nessun quiz da riprendere.');
                    location.href = 'advanced.html';
                    return;
                }
                opere = saved.opere;
                idx = Math.min(Math.max(saved.idx || 0, 0), opere.length - 1);

                if (saved.subtitle) {
                    subtitle.textContent = saved.subtitle + ' â€¢ ripresa';
                } else {
                    subtitle.textContent = 'Quiz in corso â€“ ripresa';
                }
            } else {
                // Sottotitolo per nuovo quiz
                subtitle.textContent = mode === 'advanced'
                    ? `Avanzato: sotto ${threshold}%${unseen ? ' + mai allenate' : ''}${q ? ` â€¢ filtro: "${q}"` : ''}`
                    : 'Tutte le opere (ordine casuale)';

                // Carica e filtra opere
                opere = await A.caricaOpere();
                if (q) {
                    opere = opere.filter(o => (o.titolo + ' ' + o.artista + ' ' + o.tecnica + ' ' + o.anno)
                        .toLowerCase().includes(q));
                }
                if (mode === 'advanced') {
                    opere = opere.filter(o => {
                        const { pct } = A.getPerf(o.id);
                        return pct === null ? unseen : (pct < threshold);
                    });
                }
                opere = A.shuffle(opere);
                if (opere.length === 0) {
                    alert('Nessuna opera corrisponde ai criteri del quiz.');
                    location.href = 'advanced.html';
                    return;
                }
                if (isFinite(limit)) opere = opere.slice(0, limit);
            }

            // Stato quiz
            totEl.textContent = String(opere.length);

            function persistState() {
                saveQuizState({
                    idx,
                    opere,
                    subtitle: subtitle.textContent,
                    ts: Date.now()
                });
            }

            function renderCurrent() {
                const o = opere[idx];
                idxEl.textContent = String(idx + 1);
                img.src = o.immagine;
                img.alt = `${o.titolo} â€“ ${o.artista}`;
                title.textContent = o.titolo || 'Senza titolo';
                artist.textContent = o.artista || 'Sconosciuto';
                year.textContent = o.anno || 'â€”';
                tech.textContent = o.tecnica || 'â€”';

                // reset UI
                btnShow.classList.remove('hidden');
                solution.classList.add('hidden');
                esito.classList.add('hidden');
                stage.scrollIntoView({ behavior: 'smooth', block: 'start' });

                // salva stato corrente
                persistState();
            }

            function next() {
                idx++;
                if (idx >= opere.length) {
                    clearQuizState();
                    alert('Quiz concluso! ðŸŽ‰');
                    location.href = 'index.html';
                    return;
                }
                renderCurrent();
            }

            btnShow.addEventListener('click', () => {
                btnShow.classList.add('hidden');
                solution.classList.remove('hidden');
                esito.classList.remove('hidden');
            });
            btnCorrect.addEventListener('click', () => { A.registraEsito(opere[idx].id, true); next(); });
            btnWrong.addEventListener('click', () => { A.registraEsito(opere[idx].id, false); next(); });
            btnSkip.addEventListener('click', () => { next(); });

            btnRestart.addEventListener('click', () => {
                clearQuizState();
                location.reload();
            });

            btnExit.addEventListener('click', () => {
                if (confirm('Vuoi uscire dal quiz in corso?')) {
                    clearQuizState();
                    location.href = 'advanced.html';
                }
            });

            // Viewer full-screen
            (function () {
                const viewer = document.getElementById('viewer');
                const vimg = document.getElementById('viewer-img');
                img.style.cursor = 'zoom-in';
                img.addEventListener('click', () => {
                    vimg.src = img.src;
                    vimg.alt = img.alt || '';
                    viewer.classList.add('open');
                });
                viewer.addEventListener('click', () => viewer.classList.remove('open'));
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') viewer.classList.remove('open');
                });
            })();

            renderCurrent();
        })();
    </script>
</body>

</html>